#!/usr/bin/env zsh
function db () {

  declare available_databases=($(ls $HOME/.dbs))

  if [[ -z "$1" || "$1" == "-l" ]]; then
    echo "Available databases are:"
    for db_ in "${available_databases[@]}"; do
      echo " - $db_"
    done
    return 0
  fi

  if [ ! -f $HOME/.dbs/$1 ]; then
    echo "No available db $1, choose from:"
    for db_ in "${available_databases[@]}"; do
      echo " - $db_"
    done
    return 1
  fi

  # shellcheck disable=SC1090
  . $HOME/.dbs/$1
  shift
  if [[ "$1" == "-p" ]]; then
    shift
    echo "-h ${host:?} -P ${port:?} -u ${username:?} --password=${password:?} $* ${database:?}"
    return 0
  else
    [[ $1 == "-d" ]] && cmd="mysql" && shift || cmd="mycli"
    $cmd  -h "${host:?}" -P "${port:?}" -u "${username:?}" --password="${password:?}" "$@" "${database:?}"
  fi
}
